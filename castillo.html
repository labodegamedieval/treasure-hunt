<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castillo de Gonzalo - El Misterio</title>
    <link rel="stylesheet" href="styles/style.css">
    <link rel="icon" type="image/x-icon" href="images/escudo-borrado.ico" />
</head>
<body data-stop="castillo" data-narrativa="Llegas a las faldas del castillo. El viento sopla con fuerza contra las piedras del siglo XIII. Un guardia veterano te observa desde la entrada. '¬øBuscas respuestas sobre Gonzalo?', pregunta con voz ronca.">

    <div class="escena" style="background-image: url('images/fondo-castillo.jpg');">
        
        <button class="music-btn" onclick="toggleMusic()">üéµ <span class="music-icon">Sonido</span></button>

        <div id="location-check" class="interfaz-inferior">
            <div id="texto-narrativo">El guardia bloquea el paso: 'Solo los que demuestren estar f√≠sicamente aqu√≠ pueden entrar. El mapa de Gonzalo no miente'.</div>
            <div class="opciones-narrativas">
                <button class="btn-opcion" onclick="checkLocation()">üìç Permitir que use mi GPS</button>
                <button class="btn-opcion" onclick="mostrarEntradaManual()">‚å®Ô∏è Escribir d√≥nde estoy</button>
            </div>
            <div id="location-status" style="font-size: 0.8rem; margin-top: 10px;"></div>
            
            <div id="manual-input" style="display:none; margin-top:10px;">
                <input type="text" id="location-input" placeholder="Nombre del lugar...">
                <button class="btn-opcion" onclick="checkLocationManual()">Validar</button>
            </div>
        </div>

        <div id="game-content" class="interfaz-inferior" style="display:none;">
            <div id="texto-narrativo-game">El guardia asiente: 'Est√°s en el lugar correcto. Pero Gonzalo era un hombre de secretos. Pru√©bame que eres digno de su cr√≥nica'.</div>
            
            <div class="opciones-narrativas" id="opciones-principales">
                <button class="btn-opcion" onclick="iniciarReto('visual')">ü§ù Demostrar que he observado la muralla</button>
                <button class="btn-opcion" onclick="iniciarReto('quiz')">üìö Demostrar que conozco la historia</button>
            </div>

            <div id="contenedor-visual" style="display:none;">
                <p id="pregunta-visual" class="pregunta-narrativa"></p>
                <div id="visual-opciones-1" class="opciones-narrativas"></div>
                <div id="visual-resultado-1"></div>
            </div>

            <div id="contenedor-quiz" style="display:none;">
                <p id="pregunta-quiz" class="pregunta-narrativa"></p>
                <div id="quiz-opciones-1" class="opciones-narrativas"></div>
                <div id="quiz-resultado-1"></div>
            </div>

            <div id="recompensa" style="display:none;">
                <p>El guardia se aparta: 'Gonzalo dej√≥ esto para ti...'.</p>
                <p>üß© Fragmento: <strong id="message-piece" style="color: gold;"></strong></p>
                <button id="continue-button" class="btn-opcion" style="background: #27ae60;" onclick="window.location.href='explorar.html'">üó∫Ô∏è Volver al Mapa</button>
            </div>
        </div>
    </div>

    <audio id="background-music" src="sounds/musica-medieval.mp3" loop></audio>
    <audio id="success-sound" src="sounds/success.mp3"></audio>
    <audio id="error-sound" src="sounds/error.mp3"></audio>

    <script src="scripts/script.js"></script>
    <script>
        // L√ìGICA ESPEC√çFICA PARA EL CASTILLO
        function mostrarEntradaManual() {
            document.getElementById('manual-input').style.display = 'block';
        }

        function iniciarReto(tipo) {
            document.getElementById('opciones-principales').style.display = 'none';
            if(tipo === 'visual') {
                document.getElementById('contenedor-visual').style.display = 'block';
                setupVisualChallenges(); // Llama a la funci√≥n de tu script.js original
            } else {
                document.getElementById('contenedor-quiz').style.display = 'block';
                setupQuiz(); // Llama a la funci√≥n de tu script.js original
            }
        }

        // Sobrescribimos ligeramente el checkCompletion para que se adapte a la narrativa
        function checkCompletion() {
            const stop = 'castillo';
            const v1 = localStorage.getItem(`visual-${stop}-1`) === 'true';
            const q1 = localStorage.getItem(`quiz-${stop}-1`) === 'true';
            
            // Si supera uno de los dos caminos (o ambos)
            if (v1 || q1) {
                document.getElementById('contenedor-visual').style.display = 'none';
                document.getElementById('contenedor-quiz').style.display = 'none';
                document.getElementById('recompensa').style.display = 'block';
                document.getElementById('message-piece').textContent = "El secreto";
            }
        }
    </script>
</body>
</html>
