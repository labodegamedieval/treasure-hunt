<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚õ≤ Fuente y Portal√≥n</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg">
</head>
<body>
  <div class="container">
    <header>
      <h1>‚õ≤ Fuente y Portal√≥n</h1>
      <div class="music-control">
        <button class="music-btn" onclick="toggleMusic()">
          <span class="music-icon">üéµ</span> Pausar M√∫sica
        </button>
      </div>
      <div class="stop-selector">
        <button class="action-btn" onclick="window.location.href='castillo.html'">Castillo</button>
        <button class="action-btn" onclick="window.location.href='plaza.html'">Plaza</button>
        <button class="action-btn" onclick="window.location.href='iglesia.html'">Iglesia</button>
        <button class="action-btn" onclick="window.location.href='fuente.html'">Fuente y Portal√≥n</button>
        <button class="action-btn" onclick="window.location.href='ermita.html'">Ermita</button>
        <button class="action-btn" onclick="window.location.href='puente.html'">Puente</button>
        <button class="action-btn" onclick="window.location.href='bodega.html'">Bodega</button>
        <button class="action-btn" onclick="window.location.href='cronica.html'">Cr√≥nica</button>
        <button class="action-btn" onclick="window.location.href='guia.html'">Gu√≠a</button>
      </div>
    </header>

    <section id="content">
      <div class="stop-icon">‚õ≤</div>
      <div id="location-check">
        <h2>Verifica tu ubicaci√≥n</h2>
        <p>Ac√©rcate a la Fuente y Portal√≥n para continuar la b√∫squeda del mensaje.</p>
        <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
        <p>O ingresa el nombre:</p>
        <input type="text" id="location-input" placeholder="Ej: Fuente y Portal√≥n">
        <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
        <p id="location-status"></p>
       <div class="compass-container">
    <img id="compass-background" src="images/compass-bg.png" alt="Br√∫jula">
    <img id="compass-arrow" src="images/flecha.png" alt="Flecha de direcci√≥n">
    <p id="distance-info">Calculando distancia...</p>
    <audio id="sonar-ping" src="sounds/sonar-ping.mp3" preload="auto"></audio>
</div>

<script>
let userLat = null, userLon = null, userHeading = 0;
const stops = [
    { lat: 40.001, lon: -5.501, name: "Fuente y Portal√≥n" },
    { lat: 40.002, lon: -5.502, name: "Plaza Mayor" },
    { lat: 40.003, lon: -5.503, name: "Castillo" }
];

const distanceText = document.getElementById("distance-info");
const compassArrow = document.getElementById("compass-arrow");

// Actualizar ubicaci√≥n del usuario
function updateUserLocation() {
    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(position => {
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            updateCompass();
        }, error => {
            console.error("Error GPS:", error);
            distanceText.innerText = "No se pudo obtener la ubicaci√≥n ‚ùå";
        }, { enableHighAccuracy: true });
    } else {
        distanceText.innerText = "Geolocalizaci√≥n no soportada ‚ùå";
    }
}

// Detectar orientaci√≥n del dispositivo
function updateUserHeading(event) {
    if (event.alpha !== null) {
        userHeading = event.alpha; // √Ångulo en grados
        updateCompass();
    }
}

// Funci√≥n para calcular el √°ngulo y distancia a la parada m√°s cercana
function updateCompass() {
    if (userLat === null || userLon === null) return;

    let nearestStop = null;
    let minDistance = Infinity;

    stops.forEach(stop => {
        const distance = getDistance(userLat, userLon, stop.lat, stop.lon);
        if (distance < minDistance) {
            minDistance = distance;
            nearestStop = stop;
        }
    });

    if (nearestStop) {
        // Mostrar distancia
        distanceText.innerText = `üìç Parada: ${nearestStop.name} ‚Üí ${Math.round(minDistance)}m`;

        // Calcular √°ngulo hacia la parada
        const bearing = getBearing(userLat, userLon, nearestStop.lat, nearestStop.lon);
        const angle = bearing - userHeading;

        // Rotar la flecha
        compassArrow.style.transform = `rotate(${angle}deg)`;
    }
}

// Calcular la distancia entre dos coordenadas GPS (en metros)
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLon = (lon2 - lon1) * (Math.PI / 180);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// Calcular el √°ngulo (bearing) hacia una parada
function getBearing(lat1, lon1, lat2, lon2) {
    const dLon = (lon2 - lon1) * (Math.PI / 180);
    const y = Math.sin(dLon) * Math.cos(lat2 * (Math.PI / 180));
    const x = Math.cos(lat1 * (Math.PI / 180)) * Math.sin(lat2 * (Math.PI / 180)) -
        Math.sin(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.cos(dLon);
    return (Math.atan2(y, x) * (180 / Math.PI) + 360) % 360;
}

// Iniciar funciones
updateUserLocation();
window.addEventListener("deviceorientation", updateUserHeading);
</script>

      </div>

      <div id="game-content" style="display: none;">
        <div class="content-wrapper">
          <div class="carousel">
            <div class="slide active" data-slide="0">
              <img src="images/fuente-principal.jpg" alt="Fuente Principal">
              <p class="carousel-info">
                <strong>Fuente Principal:</strong> Construida en el siglo XVI en estilo renacentista, abastec√≠a de agua al pueblo. <span class="hidden-detail" onclick="revealHint('Busca los ca√±os y observa los detalles geom√©tricos.')">¬°Busca aqu√≠!</span>
              </p>
            </div>
            <div class="slide" data-slide="1">
              <img src="images/fuente-ca√±os.jpg" alt="Ca√±os de la Fuente">
              <p class="carousel-info">
                <strong>Ca√±os:</strong> Sus dos ca√±os est√°n decorados con motivos geom√©tricos, un detalle t√≠pico del renacimiento.
              </p>
            </div>
            <div class="slide" data-slide="2">
              <img src="images/portal√≥n.jpg" alt="Portal√≥n">
              <p class="carousel-info">
                <strong>Portal√≥n:</strong> Junto a la fuente, este portal√≥n era una entrada secundaria al pueblo.
              </p>
            </div>
            <button class="carousel-btn prev-slide">‚Üê</button>
            <button class="carousel-btn next-slide">‚Üí</button>
          </div>

          <div class="visual-challenge">
            <h2>Retos Visuales: Afina tus sentidos</h2>
            <p>1. ¬øCu√°ntos ca√±os tiene la fuente?</p>
            <div id="visual-opciones-1">
              <button class="action-btn" onclick="checkVisualAnswer('Un ca√±o', 'Dos ca√±os', 1)">Un ca√±o</button>
              <button class="action-btn" onclick="checkVisualAnswer('Dos ca√±os', 'Dos ca√±os', 1)">Dos ca√±os</button>
              <button class="action-btn" onclick="checkVisualAnswer('Tres ca√±os', 'Dos ca√±os', 1)">Tres ca√±os</button>
            </div>
            <p id="visual-resultado-1"></p>
            <button class="hint-btn" onclick="showHint('Cuenta bien los chorros de agua.')">Pista</button>

            <p>2. ¬øQu√© decora los ca√±os?</p>
            <div id="visual-opciones-2">
              <button class="action-btn" onclick="checkVisualAnswer('Flores', 'Geom√©tricos', 2)">Flores</button>
              <button class="action-btn" onclick="checkVisualAnswer('Geom√©tricos', 'Geom√©tricos', 2)">Geom√©tricos</button>
              <button class="action-btn" onclick="checkVisualAnswer('Animales', 'Geom√©tricos', 2)">Animales</button>
            </div>
            <p id="visual-resultado-2"></p>
            <button class="hint-btn" onclick="showHint('Busca formas, no figuras vivas.')">Pista</button>
          </div>
        </div>

        <div class="quiz">
          <h2>Quiz: Descubre el mensaje</h2>
          <p>1. ¬øEn qu√© siglo se construy√≥ esta fuente?</p>
          <div id="quiz-opciones-1">
            <button class="action-btn" onclick="checkAnswer('XV', 'XVI', 1)">XV</button>
            <button class="action-btn" onclick="checkAnswer('XVI', 'XVI', 1)">XVI</button>
            <button class="action-btn" onclick="checkAnswer('XVII', 'XVI', 1)">XVII</button>
          </div>
          <p id="quiz-resultado-1"></p>
          <button class="hint-btn" onclick="showHint('Es renacentista, piensa en esa √©poca.')">Pista</button>

          <p>2. ¬øQu√© estilo es la fuente?</p>
          <div id="quiz-opciones-2">
            <button class="action-btn" onclick="checkAnswer('Renacentista', 'Renacentista', 2)">Renacentista</button>
            <button class="action-btn" onclick="checkAnswer('G√≥tico', 'Renacentista', 2)">G√≥tico</button>
            <button class="action-btn" onclick="checkAnswer('Barroco', 'Renacentista', 2)">Barroco</button>
          </div>
          <p id="quiz-resultado-2"></p>
          <button class="hint-btn" onclick="showHint('Piensa en el siglo XVI.')">Pista</button>

          <p>3. ¬øQu√© r√≠o pasa cerca?</p>
          <div id="quiz-opciones-3">
            <button class="action-btn" onclick="checkAnswer('Canderuelo', 'Canderuelo', 3)">Canderuelo</button>
            <button class="action-btn" onclick="checkAnswer('Francia', 'Canderuelo', 3)">Francia</button>
            <button class="action-btn" onclick="checkAnswer('Tormes', 'Canderuelo', 3)">Tormes</button>
          </div>
          <p id="quiz-resultado-3"></p>
          <button class="hint-btn" onclick="showHint('Es un r√≠o local de la Sierra.')">Pista</button>
        </div>

        <div id="continue-button" style="display: none;">
          <button class="action-btn" onclick="window.location.href='felicitaciones.html?stop=fuente'">Continuar b√∫squeda</button>
        </div>

        <p class="info">
          <strong>Fragmento del Mensaje:</strong> <span id="message-piece" style="display: none;">"con un escudo de armas"</span><br>
          <strong>QR en el pueblo:</strong> FUENTE-1600 (cerca de la fuente).<br>
          <strong>Dato Curioso:</strong> La fuente fue un punto clave para los habitantes en el siglo XVI.
        </p>
      </div>
    </section>

    <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
<audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
<audio id="coins-sound" src="sounds/coins.mp3" preload="auto"></audio>
<audio id="ambient-sound" src="sounds/musica-medieval-2.mp3" preload="auto" loop></audio>
<audio id="sonar-ping" src="sounds/sonar-ping.mp3" preload="auto"></audio>
  </div>

  <footer>
    <p>¬© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a></p>
  </footer>

  <script src="script.js"></script>
</body>
</html>
