<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚õ≤ Fuente y Portal√≥n</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg">
</head>
<body>
  <div class="container">
    <header>
      <h1>‚õ≤ Fuente y Portal√≥n</h1>
      <div class="music-control">
        <button class="music-btn" onclick="toggleMusic()">
          <span class="music-icon">üéµ</span> Pausar M√∫sica
        </button>
      </div>
      <div class="stop-selector">
        <button class="action-btn" onclick="window.location.href='castillo.html'">Castillo</button>
        <button class="action-btn" onclick="window.location.href='plaza.html'">Plaza</button>
        <button class="action-btn" onclick="window.location.href='iglesia.html'">Iglesia</button>
        <button class="action-btn" onclick="window.location.href='fuente.html'">Fuente y Portal√≥n</button>
        <button class="action-btn" onclick="window.location.href='ermita.html'">Ermita</button>
        <button class="action-btn" onclick="window.location.href='puente.html'">Puente</button>
        <button class="action-btn" onclick="window.location.href='bodega.html'">Bodega</button>
        <button class="action-btn" onclick="window.location.href='cronica.html'">Cr√≥nica</button>
        <button class="action-btn" onclick="window.location.href='guia.html'">Gu√≠a</button>
      </div>
    </header>

    <section id="content">
      <div class="stop-icon">‚õ≤</div>
      <div id="location-check">
        <h2>Verifica tu ubicaci√≥n</h2>
        <p>Ac√©rcate a la Fuente y Portal√≥n para continuar la b√∫squeda del mensaje.</p>
        <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
        <p>O ingresa el nombre:</p>
        <input type="text" id="location-input" placeholder="Ej: Fuente y Portal√≥n">
        <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
        <p id="location-status"></p>
        <canvas id="sonar-radar" width="200" height="200"></canvas>
<audio id="sonar-ping" src="sounds/sonar-ping.mp3" preload="auto"></audio>

<script>
const canvas = document.getElementById("sonar-radar");
const ctx = canvas.getContext("2d");
const audioPing = document.getElementById("sonar-ping");

let angle = 0; // √Ångulo del radar
let lastTime = 0;

// Simulaci√≥n de paradas con coordenadas relativas al radar
const stops = [
    { x: 50, y: 20, detected: false },  
    { x: -40, y: 60, detected: false },  
    { x: 30, y: -50, detected: false }  
];

// Funci√≥n para dibujar el radar con estela m√°s larga y detecci√≥n GPS
function animateRadar(timestamp) {
    if (!lastTime) lastTime = timestamp;
    const deltaTime = timestamp - lastTime;

    if (deltaTime > 16) { // Control de FPS (~60 FPS)
        lastTime = timestamp;

        // Efecto de estela m√°s larga (¬º de la circunferencia)
        ctx.fillStyle = "rgba(10, 10, 10, 0.2)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Dibujar c√≠rculos conc√©ntricos
        ctx.strokeStyle = "rgba(0, 255, 0, 0.5)";
        ctx.lineWidth = 2;
        for (let i = 1; i <= 3; i++) {
            ctx.beginPath();
            ctx.arc(100, 100, i * 30, 0, Math.PI * 2);
            ctx.stroke();
        }

        // Dibujar el rayo del radar con estela m√°s larga
        for (let i = 0; i < Math.PI / 2; i += 0.05) {
            let trailAngle = angle - i;
            let xTrail = 100 + 100 * Math.cos(trailAngle);
            let yTrail = 100 + 100 * Math.sin(trailAngle);
            ctx.beginPath();
            ctx.moveTo(100, 100);
            ctx.lineTo(xTrail, yTrail);
            ctx.strokeStyle = `rgba(0, 255, 0, ${1 - i / (Math.PI / 2)})`; // Desvanecimiento
            ctx.lineWidth = 3;
            ctx.stroke();
        }

        // Dibujar las paradas como puntos verdes
        stops.forEach(stop => {
            ctx.beginPath();
            ctx.arc(100 + stop.x, 100 + stop.y, 5, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(0, 255, 0, 1)";
            ctx.fill();

            // Detecci√≥n de colisi√≥n con el rayo
            const dx = (100 + stop.x) - (100 + 100 * Math.cos(angle));
            const dy = (100 + stop.y) - (100 + 100 * Math.sin(angle));
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < 10 && !stop.detected) {
                stop.detected = true; // Evitar que suene varias veces
                audioPing.play();
                checkGPSUnlock(stop);
            }
        });

        // Movimiento progresivo del radar
        angle += 0.05;
        if (angle > Math.PI * 2) angle = 0;
    }

    requestAnimationFrame(animateRadar);
}

// Funci√≥n para verificar si se desbloquea la parada por GPS
function checkGPSUnlock(stop) {
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                console.log(`GPS detectado: ${userLat}, ${userLon}`);

                // Coordenadas de prueba (¬°ajusta con coordenadas reales!)
                const stopLat = 40.0000; // Modificar con latitud real
                const stopLon = -5.5000; // Modificar con longitud real

                const distance = getDistance(userLat, userLon, stopLat, stopLon);
                console.log(`Distancia a parada: ${distance} metros`);

                if (distance < 20) {
                    document.getElementById("location-status").innerText = "Ubicaci√≥n verificada ‚úÖ";
                } else {
                    document.getElementById("location-status").innerText = "Ubicaci√≥n incorrecta ‚ùå";
                }
            },
            function(error) {
                console.error("Error al obtener GPS:", error);
                document.getElementById("location-status").innerText = "No se pudo obtener la ubicaci√≥n ‚ùå";
            }
        );
    } else {
        console.log("Geolocalizaci√≥n no soportada");
    }
}

// Funci√≥n para calcular la distancia en metros entre dos puntos GPS
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // Radio de la Tierra en metros
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLon = (lon2 - lon1) * (Math.PI / 180);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

// Iniciar la animaci√≥n
requestAnimationFrame(animateRadar);
</script>

      </div>

      <div id="game-content" style="display: none;">
        <div class="content-wrapper">
          <div class="carousel">
            <div class="slide active" data-slide="0">
              <img src="images/fuente-principal.jpg" alt="Fuente Principal">
              <p class="carousel-info">
                <strong>Fuente Principal:</strong> Construida en el siglo XVI en estilo renacentista, abastec√≠a de agua al pueblo. <span class="hidden-detail" onclick="revealHint('Busca los ca√±os y observa los detalles geom√©tricos.')">¬°Busca aqu√≠!</span>
              </p>
            </div>
            <div class="slide" data-slide="1">
              <img src="images/fuente-ca√±os.jpg" alt="Ca√±os de la Fuente">
              <p class="carousel-info">
                <strong>Ca√±os:</strong> Sus dos ca√±os est√°n decorados con motivos geom√©tricos, un detalle t√≠pico del renacimiento.
              </p>
            </div>
            <div class="slide" data-slide="2">
              <img src="images/portal√≥n.jpg" alt="Portal√≥n">
              <p class="carousel-info">
                <strong>Portal√≥n:</strong> Junto a la fuente, este portal√≥n era una entrada secundaria al pueblo.
              </p>
            </div>
            <button class="carousel-btn prev-slide">‚Üê</button>
            <button class="carousel-btn next-slide">‚Üí</button>
          </div>

          <div class="visual-challenge">
            <h2>Retos Visuales: Afina tus sentidos</h2>
            <p>1. ¬øCu√°ntos ca√±os tiene la fuente?</p>
            <div id="visual-opciones-1">
              <button class="action-btn" onclick="checkVisualAnswer('Un ca√±o', 'Dos ca√±os', 1)">Un ca√±o</button>
              <button class="action-btn" onclick="checkVisualAnswer('Dos ca√±os', 'Dos ca√±os', 1)">Dos ca√±os</button>
              <button class="action-btn" onclick="checkVisualAnswer('Tres ca√±os', 'Dos ca√±os', 1)">Tres ca√±os</button>
            </div>
            <p id="visual-resultado-1"></p>
            <button class="hint-btn" onclick="showHint('Cuenta bien los chorros de agua.')">Pista</button>

            <p>2. ¬øQu√© decora los ca√±os?</p>
            <div id="visual-opciones-2">
              <button class="action-btn" onclick="checkVisualAnswer('Flores', 'Geom√©tricos', 2)">Flores</button>
              <button class="action-btn" onclick="checkVisualAnswer('Geom√©tricos', 'Geom√©tricos', 2)">Geom√©tricos</button>
              <button class="action-btn" onclick="checkVisualAnswer('Animales', 'Geom√©tricos', 2)">Animales</button>
            </div>
            <p id="visual-resultado-2"></p>
            <button class="hint-btn" onclick="showHint('Busca formas, no figuras vivas.')">Pista</button>
          </div>
        </div>

        <div class="quiz">
          <h2>Quiz: Descubre el mensaje</h2>
          <p>1. ¬øEn qu√© siglo se construy√≥ esta fuente?</p>
          <div id="quiz-opciones-1">
            <button class="action-btn" onclick="checkAnswer('XV', 'XVI', 1)">XV</button>
            <button class="action-btn" onclick="checkAnswer('XVI', 'XVI', 1)">XVI</button>
            <button class="action-btn" onclick="checkAnswer('XVII', 'XVI', 1)">XVII</button>
          </div>
          <p id="quiz-resultado-1"></p>
          <button class="hint-btn" onclick="showHint('Es renacentista, piensa en esa √©poca.')">Pista</button>

          <p>2. ¬øQu√© estilo es la fuente?</p>
          <div id="quiz-opciones-2">
            <button class="action-btn" onclick="checkAnswer('Renacentista', 'Renacentista', 2)">Renacentista</button>
            <button class="action-btn" onclick="checkAnswer('G√≥tico', 'Renacentista', 2)">G√≥tico</button>
            <button class="action-btn" onclick="checkAnswer('Barroco', 'Renacentista', 2)">Barroco</button>
          </div>
          <p id="quiz-resultado-2"></p>
          <button class="hint-btn" onclick="showHint('Piensa en el siglo XVI.')">Pista</button>

          <p>3. ¬øQu√© r√≠o pasa cerca?</p>
          <div id="quiz-opciones-3">
            <button class="action-btn" onclick="checkAnswer('Canderuelo', 'Canderuelo', 3)">Canderuelo</button>
            <button class="action-btn" onclick="checkAnswer('Francia', 'Canderuelo', 3)">Francia</button>
            <button class="action-btn" onclick="checkAnswer('Tormes', 'Canderuelo', 3)">Tormes</button>
          </div>
          <p id="quiz-resultado-3"></p>
          <button class="hint-btn" onclick="showHint('Es un r√≠o local de la Sierra.')">Pista</button>
        </div>

        <div id="continue-button" style="display: none;">
          <button class="action-btn" onclick="window.location.href='felicitaciones.html?stop=fuente'">Continuar b√∫squeda</button>
        </div>

        <p class="info">
          <strong>Fragmento del Mensaje:</strong> <span id="message-piece" style="display: none;">"con un escudo de armas"</span><br>
          <strong>QR en el pueblo:</strong> FUENTE-1600 (cerca de la fuente).<br>
          <strong>Dato Curioso:</strong> La fuente fue un punto clave para los habitantes en el siglo XVI.
        </p>
      </div>
    </section>

    <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
<audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
<audio id="coins-sound" src="sounds/coins.mp3" preload="auto"></audio>
<audio id="ambient-sound" src="sounds/musica-medieval-2.mp3" preload="auto" loop></audio>
<audio id="sonar-ping" src="sounds/sonar-ping.mp3" preload="auto"></audio>
  </div>

  <footer>
    <p>¬© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a></p>
  </footer>

  <script src="script.js"></script>
</body>
</html>
